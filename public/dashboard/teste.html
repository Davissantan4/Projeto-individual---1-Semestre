<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <script src="../js/sessao.js"></script>
</head>

<body onload="validarSessao(), carregarQuizzes()">
    <select id="quizSelect"><option value="#">Selecione um Quiz</option></select>
    <div id="quizContainer" onload="carregarQuestoes()"></div>
    <button onclick="enviarRespostas()">Enviar Respostas</button>
</body>
<script>
    let quizSelecionado = null;
    let respostas = [];

    async function carregarQuizzes() {
        const res = await fetch('/quizzes/listar');
        const quizzes = await res.json();
        const select = document.getElementById('quizSelect');
        quizzes.forEach(q => {
            const option = document.createElement('option');
            option.value = q.id;
            option.textContent = q.descricao;
            select.appendChild(option);
        });
    }

    async function carregarQuestoes() {
        const id = document.getElementById('quizSelect').value;
        quizSelecionado = id;
        const res = await fetch(`/quizzes/quiz/${id}/questoes`);
        const questoes = await res.json();
        

        const container = document.getElementById('quizContainer');
        container.innerHTML = '';

        questoes.forEach(q => {
            const div = document.createElement('div');
            div.innerHTML = `<p>${q.enunciado}</p>
            <label>A <input type="radio" name="questao${q.idQuestao}" value="A"></label>
            <label>B <input type="radio" name="questao${q.idQuestao}" value="B"></label>
            <label>C <input type="radio" name="questao${q.idQuestao}" value="C"></label>
            <label>D <input type="radio" name="questao${q.idQuestao}" value="D"></label>`;
            container.appendChild(div);
        });
    }

    async function enviarRespostas() {
        const questoes = document.querySelectorAll('#quizContainer div');
        const respostas = [];

        questoes.forEach(div => {
            const idQuestao = div.querySelector('input').name.replace('questao', '');
            const alternativa = div.querySelector('input:checked').value;

            respostas.push({ idQuestao: idQuestao, alternativa: alternativa, idResposta: 3 });
        });

        const res = await fetch(`/quizzes/quiz/${quizSelecionado}/responder`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                idUsuario: sessionStorage.ID_USUARIO,
                respostas: respostas
            })
        });

        const data = await res.json();
        alert(data.message);
    }

    carregarQuizzes();
    document.getElementById('quizSelect').addEventListener('change', carregarQuestoes);
</script>

</html>